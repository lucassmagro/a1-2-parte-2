<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YTS API | Lucas Santos Magro</title>

    <link rel="icon" 
          href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='90' font-size='90'>üé¨</text></svg>"
          type="image/svg+xml">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <link rel="stylesheet" href="style.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;700&display=swap" rel="stylesheet">

</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="#" onclick="location.reload()">YTS API</a>
            <div class="ms-auto">
                <div class="input-group">
                    <input type="text" id="inputBusca" class="form-control" placeholder="Buscar filme..." aria-label="Buscar filme">
                    <button id="btnBuscar" class="btn btn-primary" type="button">Buscar</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        
        <section class="filter-controls mb-4 p-3 rounded">
            <div class="row g-2 align-items-center">
                <div class="col-12 col-sm-auto"><span class="me-2">Filtros:</span></div>
                <div class="col-6 col-sm-auto"><button id="btnCarregarPopulares" class="btn btn-sm w-100">Populares</button></div>
                <div class="col-6 col-sm-auto"><button id="btnAltaAvaliacao" class="btn btn-sm w-100">Melhores Notas</button></div>
                <div class="col-6 col-sm-auto"><button id="btnMaisBaixados" class="btn btn-sm w-100">Mais Baixados</button></div>
                <div class="col-6 col-sm-auto">
                    <select id="selectGenero" class="form-select form-select-sm">
                        <option value="">G√™nero...</option>
                        <option value="action">A√ß√£o</option><option value="comedy">Com√©dia</option><option value="horror">Terror</option><option value="romance">Romance</option><option value="sci-fi">Fic√ß√£o Cient√≠fica</option><option value="thriller">Suspense</option>
                    </select>
                </div>
            </div>
        </section>

        <main>
            <h2 id="tituloResultados" class="mb-3 ps-2 border-start border-primary border-3">Carregando...</h2>
            <div id="status" class="alert alert-info" style="display: none;"></div>
            <div id="resultados" class="row g-4"></div>
        </main>
        
        <footer class="text-center mt-5 mb-3">
            <p>Desenvolvido por Lucas Santos Magro utilizando a <a href="https://yts.mx/api" target="_blank">API YTS</a>.</p>
        </footer>
    </div>

    <!-- botao logs -->
    <button class="btn-logs" data-bs-toggle="modal" data-bs-target="#modalLogs" title="Ver Logs">
        Logs
    </button>

    <!-- modal logs -->
    <div class="modal fade" id="modalLogs" tabindex="-1" aria-labelledby="modalLogsLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLogsLabel">Hist√≥rico de Logs</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="listaLogs">
                        <p class="text-center">Carregando logs...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        const API_BASE_URL = 'https://yts.mx/api/v2/';
        const LOG_API_URL = 'https://www.piway.com.br/unoesc/api/';
        const MATRICULA = '315998';
        
        const ELEMENTOS = {
            btnCarregarPopulares: document.getElementById('btnCarregarPopulares'),
            btnBuscar: document.getElementById('btnBuscar'),
            inputBusca: document.getElementById('inputBusca'),
            btnAltaAvaliacao: document.getElementById('btnAltaAvaliacao'),
            btnMaisBaixados: document.getElementById('btnMaisBaixados'),
            selectGenero: document.getElementById('selectGenero'),
            resultadosDiv: document.getElementById('resultados'),
            statusDiv: document.getElementById('status'),
            tituloResultados: document.getElementById('tituloResultados'),
            listaLogs: document.getElementById('listaLogs')
        };

        //registrar Log
        async function registrarLog(endpoint, metodo = 'GET') {
            try {
                const logData = {
                    aluno: MATRICULA,
                    endpoint: endpoint,
                    metodo: metodo
                };

                const resposta = await fetch(`${LOG_API_URL}inserir`, {
                    method: 'POST',
                    headers: 
                    {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(logData)
                });

                if (!resposta.ok) {
                    console.error('Erro ao registrar log:', resposta.statusText);
                }
            } catch (erro) {
                console.error('Erro ao registrar log:', erro);
            }
        }

        //carregar e exibir logs
        async function carregarLogs() {
            try {
                ELEMENTOS.listaLogs.innerHTML = '<p class="text-center">Carregando logs...</p>';
                
                const resposta = await fetch(`${LOG_API_URL}logs/${encodeURIComponent(MATRICULA)}`);
                
                if (!resposta.ok) {
                    throw new Error('Erro ao carregar logs');
                }

                const logs = await resposta.json();
                
                if (!logs || logs.length === 0) {
                    ELEMENTOS.listaLogs.innerHTML = '<p class="text-center">Nenhum log registrado ainda.</p>';
                    return;
                }

                exibirLogs(logs);
                
            } catch (erro) {
                console.error('Erro ao carregar logs:', erro);
                ELEMENTOS.listaLogs.innerHTML = '<p class="text-center text-danger">Erro ao carregar logs. Tente novamente.</p>';
            }
        }

        function exibirLogs(logs) {
            ELEMENTOS.listaLogs.innerHTML = '';
            
            logs.forEach((log, index) => {
                const dataFormatada = new Date(log.data).toLocaleString('pt-BR');
                
                const logItem = document.createElement('div');
                logItem.className = 'log-item';
                logItem.innerHTML = `
                    <div class="log-header">
                        <div>
                            <strong>Log #${logs.length - index}</strong>
                            <div class="log-info">
                                <small>${dataFormatada}</small>
                            </div>
                        </div>
                        <button class="btn-delete-log" onclick="excluirLog(${log.id})">
                            Excluir
                        </button>
                    </div>
                    <div class="log-info">
                        <strong>Endpoint:</strong> ${log.endpoint}<br>
                        <strong>M√©todo:</strong> <span class="badge bg-info">${log.metodo}</span>
                    </div>
                `;
                
                ELEMENTOS.listaLogs.appendChild(logItem);
            });
        }

        //excluir Log
        async function excluirLog(id) {
            try {
                const resposta = await fetch(`${LOG_API_URL}excluir/${id}`, {
                    method: 'DELETE'
                });

                if (!resposta.ok) {
                    throw new Error('Erro ao excluir log');
                }

                alert('Log excluido com sucesso');
                carregarLogs();
            } catch (erro) {
                console.error('Erro ao excluir log:', erro);
                alert('Erro ao excluir log.');
            }
        }

        function mostrarStatus(mensagem, tipo = 'info') {
            ELEMENTOS.statusDiv.className = `alert alert-${tipo}`;
            ELEMENTOS.statusDiv.textContent = mensagem;
            ELEMENTOS.statusDiv.style.display = 'block';
            ELEMENTOS.resultadosDiv.innerHTML = '';
        }

        async function buscarListaDeFilmes(endpoint, tituloSecao = 'Resultados da Busca') {
            mostrarStatus('Buscando filmes...', 'info');
            ELEMENTOS.tituloResultados.textContent = tituloSecao;

            try {
                const resposta = await fetch(`${API_BASE_URL}${endpoint}`);
                if (!resposta.ok) throw new Error(`Erro na rede: ${resposta.statusText} (c√≥digo ${resposta.status})`);
                
                const dados = await resposta.json();
                
                //registrar log
                await registrarLog(endpoint, 'GET');
                
                if (dados.status !== 'ok' || !dados.data.movies || dados.data.movie_count === 0) {
                    throw new Error('Nenhum filme encontrado com este crit√©rio.');
                }

                ELEMENTOS.statusDiv.style.display = 'none';
                exibirListaDeFilmes(dados.data.movies);
            } catch (erro) {
                mostrarStatus(`Ocorreu um erro: ${erro.message}. Verifique sua conex√£o ou tente novamente.`, 'danger');
                console.error(erro);
            }
        }
        
        function exibirListaDeFilmes(filmes) {
            ELEMENTOS.resultadosDiv.innerHTML = '';
            filmes.forEach(filme => {
                const coluna = document.createElement('div');
                coluna.className = 'col-6 col-md-4 col-lg-3 col-xl-2 mb-4';
                coluna.innerHTML = `
                    <div class="card h-100 movie-card" data-movie-id="${filme.id}">
                        <img src="${filme.medium_cover_image}" class="card-img-top" alt="P√¥ster de ${filme.title}" loading="lazy">
                        <div class="card-body">
                            <h5 class="card-title">${filme.title}</h5>
                            <p class="card-text d-flex justify-content-between">
                                ${filme.year}
                                <span class="badge bg-rating text-white">‚òÖ ${filme.rating}</span>
                            </p>
                        </div>
                    </div>`;
                ELEMENTOS.resultadosDiv.appendChild(coluna);
            });
        }

        async function buscarDetalhesDoFilme(id) {
            mostrarStatus('Carregando detalhes do filme...', 'info');
            try {
                const endpoint = `movie_details.json?movie_id=${id}&with_images=true&with_cast=true`;
                const resposta = await fetch(`${API_BASE_URL}${endpoint}`);
                if (!resposta.ok) throw new Error(`Erro na rede: ${resposta.statusText}`);

                const dados = await resposta.json();
                
                //registrar log
                await registrarLog(endpoint, 'GET');
                
                if (dados.status !== 'ok') throw new Error('N√£o foi poss√≠vel carregar os detalhes.');

                ELEMENTOS.statusDiv.style.display = 'none';
                exibirDetalhesDoFilme(dados.data.movie);
            } catch (erro) {
                mostrarStatus(`Ocorreu um erro: ${erro.message}`, 'danger');
                console.error(erro);
            }
        }

        function exibirDetalhesDoFilme(filme) {
            ELEMENTOS.resultadosDiv.innerHTML = '';
            ELEMENTOS.tituloResultados.textContent = filme.title_long;

            const generos = filme.genres ? filme.genres.join(', ') : 'N√£o informado';
            const downloadsFormatado = (typeof filme.download_count === 'number') ? filme.download_count.toLocaleString('pt-BR') : 'N√£o informado';

            ELEMENTOS.resultadosDiv.innerHTML = `
                <div class="col-md-4 col-lg-3 text-center text-md-start">
                    <img src="${filme.large_cover_image}" class="img-fluid rounded shadow-lg details-img" alt="P√¥ster de ${filme.title}">
                </div>
                <div class="col-md-8 col-lg-9">
                    <p class="lead">${filme.description_full || 'Sinopse n√£o dispon√≠vel.'}</p>
                    <hr>
                    <p><strong>G√™neros:</strong> ${generos}</p>
                    <p><strong>Nota:</strong> <span class="badge bg-rating text-white fs-6">‚òÖ ${filme.rating} / 10</span></p>
                    <p><strong>Downloads:</strong> ${downloadsFormatado}</p>
                    <a href="${filme.url}" target="_blank" class="btn btn-action mt-2">Ver no YTS</a>
                    <button class="btn btn-outline-light mt-2" onclick="ELEMENTOS.btnCarregarPopulares.click()">‚Üê Voltar aos Populares</button>
                </div>`;
        }

        function realizarBusca() {
            const termoBusca = ELEMENTOS.inputBusca.value.trim();
            if (termoBusca) {
                buscarListaDeFilmes(`list_movies.json?query_term=${termoBusca}&limit=30`, `Resultados para "${termoBusca}"`);
            } else {
                mostrarStatus('Digite um termo para buscar.', 'warning');
            }
        }

        ELEMENTOS.btnCarregarPopulares.addEventListener('click', () => buscarListaDeFilmes('list_movies.json?sort_by=rating&limit=30', 'Filmes Populares'));
        ELEMENTOS.btnAltaAvaliacao.addEventListener('click', () => buscarListaDeFilmes('list_movies.json?minimum_rating=8&sort_by=like_count&limit=30', 'Filmes com Melhores Notas'));
        ELEMENTOS.btnMaisBaixados.addEventListener('click', () => buscarListaDeFilmes('list_movies.json?sort_by=download_count&limit=30', 'Filmes Mais Baixados'));
        ELEMENTOS.selectGenero.addEventListener('change', () => {
            const genero = ELEMENTOS.selectGenero.value;
            if (genero) buscarListaDeFilmes(`list_movies.json?genre=${genero}&limit=30`, `G√™nero: ${genero}`);
        });

        ELEMENTOS.btnBuscar.addEventListener('click', realizarBusca);
        ELEMENTOS.inputBusca.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') realizarBusca();
        });

        ELEMENTOS.resultadosDiv.addEventListener('click', (event) => {
            const cardClicado = event.target.closest('.movie-card');
            if (cardClicado) {
                const movieId = cardClicado.dataset.movieId;
                if(movieId) buscarDetalhesDoFilme(movieId);
            }
        });

        //carregar logs quando o modal eh aberto
        document.getElementById('modalLogs').addEventListener('show.bs.modal', function () {
            carregarLogs();
        });

        document.addEventListener('DOMContentLoaded', () => {
            ELEMENTOS.btnCarregarPopulares.click();
        });
    </script>

</body>
</html>